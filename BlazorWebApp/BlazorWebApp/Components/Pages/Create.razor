@page "/Create"
@using System.Text
@using System.Text.Json
@using System.Net.Http.Headers
@using System.Text.Json.Serialization
@using Azure
@using System
@using System.Data
@using Microsoft.AspNetCore.Authentication
@using Microsoft.Data.SqlClient

@rendermode InteractiveServer

<PageTitle>Create</PageTitle>

<h1>Create</h1>

<label for="issue">Enter the issue:</label>
<input type="text" id="issue" name="issue" @bind="issue" />
<h1>Secret: @a</h1>

<button type="submit" @onclick="SendData">Send</button>
@code {
    private string issue;
    private static readonly HttpClient client = new HttpClient();

    // LLM values
    private string a = System.Environment.GetEnvironmentVariable("apikeyllm");
    private readonly IWebHostEnvironment _env;
    private string ApiKey = "e323124e397b4928bb4d26f704cb1447";
    private string Endpoint = "https://kickets-more.openai.azure.com/";
    private string DeploymentId = "gpt-4-0613-kickets-kelag";
    private string ApiVersion = "2024-02-01";
    private double Temperature = 0.5;

    private string SystemPrompt = @"To effectively generate structured JSON responses for IT issue tracking in English, ensure adherence to specific label constraints provided. Follow this method:
    
    1. Understand and Analyze the Input:
       - Read the user input carefully to extract essential details such as the type of issue, specific system involved, and the nature of the problem. Base your understanding strictly on the information provided in the input.

    2. Construct a Structured Response:
       - title: Create a concise title that captures the main issue along with specifics about the system affected and any relevant identification numbers. Ensure all text is in English.
       - labels: Choose labels only from the predefined set that best fit the context of the issue. The labels available are [bug, documentation, duplicate, enhancement, good first issue, help wanted, invalid, question, wontfix]. Select those that most accurately describe the category and urgency of the issue.
       - service Name: English only: State clearly the service or system impacted, including any identifiers or codes, ensuring all text is in English only in English.
       - description: Write a detailed description of the problem in English only in English, starting with a clear statement of the main issue followed by directives for needed actions. Highlight the urgency and importance of resolving the issue to maintain smooth operations.

    3. Format the JSON Output:
       - The output should be a JSON object with clearly defined keys: 'title', 'labels', 'service Name', and 'description'. Each key must contain information accurately derived from the user's input and formatted clearly in English.

    Example JSON Output for Training:
    {
      'title': 'Account Locked in Active Directory (BKS-System) (TISC-53699)',
      'labels': ['bug', 'help wanted', ....],
      'service Name': 'Active Directory (BKS-System) (TISC-53699)',
      'description': 'Problem: Account locked. Please thoroughly check the system and take necessary actions to resolve the issue. It is crucial that this problem is resolved promptly and efficiently to ensure smooth operation.'
    }

    Ensure every word is in English!!! Only English!!!";

    private async Task SendData()
    {

        Console.WriteLine("Enviroment" + Environment.GetEnvironmentVariable(""));
        Console.WriteLine(issue);
        Console.WriteLine("63: " + Environment.GetEnvironmentVariable("APIKEY"));
        client.DefaultRequestHeaders.Clear();
        client.DefaultRequestHeaders.Add("api-key", ApiKey);


        var json_data = new
        {
            messages = new[]
            {
                new { role = "system", content = SystemPrompt },
                new { role = "user", content = issue }
            },
            max_tokens = 500,
            temperature = Temperature
        };


        var json = JsonSerializer.Serialize(json_data);
        var content = new StringContent(json, Encoding.UTF8, "application/json"); // Here 'Content-Type' is correctly set

        var url = $"{Endpoint}openai/deployments/{DeploymentId}/chat/completions?api-version={ApiVersion}";
        var response = await client.PostAsync(url, content);

        if (!response.IsSuccessStatusCode)
        {
            return;
        }

        var responseContent = await response.Content.ReadAsStringAsync();
        Console.WriteLine("ResponseContent: " + responseContent);
        try
        {
            JsonDocument jsonDoc = JsonDocument.Parse(responseContent);
            JsonElement root = jsonDoc.RootElement;
            JsonElement choicesArray = root.GetProperty("choices");
            if (!choicesArray.EnumerateArray().Any())
            {
                return;
            }

            Console.WriteLine("102");

            JsonElement firstChoice = choicesArray.EnumerateArray().First();
            JsonElement messageElement;
            if (!(firstChoice.TryGetProperty("message", out messageElement)))
            {
                return;
            }

            Console.WriteLine("110");

            if (!(messageElement.ValueKind == JsonValueKind.Object))
            {
                return;
            }

            // Process messageElement as an object
            Console.WriteLine("92: " + messageElement);

            JsonElement root1 = messageElement;
            JsonElement contentElement = root1.GetProperty("content");

            // Parse the content string as a separate JSON document
            Console.WriteLine("124");

            var temp = contentElement.GetString().Replace("'", "\"");
            JsonDocument innerDoc = JsonDocument.Parse(temp);
            Console.WriteLine("27");

            JsonElement innerRoot = innerDoc.RootElement;
            Console.WriteLine("130");


            string title = innerRoot.GetProperty("title").GetString();
            Console.WriteLine($"Title: {title}");

            string description = innerRoot.GetProperty("description").GetString();
            string serviceName = innerRoot.GetProperty("service Name").GetString();
            string[] labels = innerRoot.GetProperty("labels").EnumerateArray().Select(l => l.GetString()).ToArray();

            Console.WriteLine($"Description: {description}");
            Console.WriteLine($"Service Name: {serviceName}");
            Console.WriteLine($"Labels: {string.Join(", ", labels)}");
            DbIssue dbIssue = new DbIssue();
            dbIssue.description = description;
            dbIssue.labels = labels;
            dbIssue.title = title;
            dbIssue.serviceName = serviceName;

            //save to db
            string connectionString = "Server=tcp:issues-db.database.windows.net,1433;Initial Catalog=issues-db;Persist Security Info=False;User ID=AdminDB;Password=BauerDieMauer1!;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;";
            try
            {
                using (var conn = new SqlConnection(connectionString))
                {
                    conn.Open();
                    var command = new SqlCommand("SELECT COUNT(*) FROM Issues WHERE title LIKE @title", conn);
                    command.Parameters.Add("@title", SqlDbType.Text).Value = "%" + dbIssue.title + "%";

                    int count = (int)await command.ExecuteScalarAsync();

                    if (count == 0)
                    {
                        //No Duplicate
                        Console.WriteLine("No DUplicate");
                        command = new SqlCommand(
                            "INSERT INTO Issues (title, description, service, labels) VALUES (@title,@description,@service,@labels);",
                            conn);
                        command.Parameters.Add("@title", SqlDbType.Text).Value = dbIssue.title;
                        command.Parameters.AddWithValue("@description", dbIssue.description);
                        command.Parameters.AddWithValue("@service", dbIssue.serviceName);
                        command.Parameters.AddWithValue("@labels", string.Join(';', dbIssue.labels));
                        command.ExecuteNonQuery();
                    }
                    else
                    {
                        //Is Duplicate
                        Console.WriteLine("Duplicate");
                        dbIssue.labels = dbIssue.labels.Concat(new[] { "duplicate" }).ToArray();
                        Console.WriteLine(dbIssue.labels);
                        command = new SqlCommand(
                            "INSERT INTO Issues (title, description, service, labels) VALUES (@title,@description,@service,@labels);",
                            conn);
                        command.Parameters.Add("@title", SqlDbType.Text).Value = dbIssue.title;
                        command.Parameters.AddWithValue("@description", dbIssue.description);
                        command.Parameters.AddWithValue("@service", dbIssue.serviceName);
                        command.Parameters.AddWithValue("@labels", string.Join(';', dbIssue.labels));
                        command.ExecuteNonQuery();

                    }
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
            }

            //To Github
            GitIssue githubIssue = DbIssueToGitIssue(dbIssue);
            Console.WriteLine("GitIssue: " + githubIssue);
            await MakeRequest(githubIssue);


        }
        catch (Exception ex)
        {
            Console.WriteLine("Error parsing JSON: " + ex.Message);
        }





    }

    private static async Task MakeRequest(GitIssue issueData)
    {
        Console.WriteLine("53");
        Console.WriteLine(issueData);

        // Request headers
        client.DefaultRequestHeaders.CacheControl = CacheControlHeaderValue.Parse("no-cache");
        client.DefaultRequestHeaders.Add("Ocp-Apim-Subscription-Key", "31ed80b9e6264b81b70c8abed0a7d156");

        var uri = "https://apim-forstsee-hackathon.azure-api.net/github/Kelag-Hackathon-2024-Team-7/issues";
        // Serialize the JSON object to a string
        var json = JsonSerializer.Serialize(issueData, new JsonSerializerOptions { WriteIndented = true });
        Console.WriteLine(json);

        using (var content = new StringContent(json, Encoding.UTF8, "application/json"))
        {
            HttpResponseMessage response = await client.PostAsync(uri, content);
            Console.WriteLine(response);
        }
    }

    public class DbIssue
    {
        [JsonPropertyName("title")] public string title { get; set; }

        [JsonPropertyName("description")] public string description { get; set; }

        [JsonPropertyName("service-name")] public string serviceName { get; set; }

        [JsonPropertyName("labels")] public string[] labels { get; set; }

        //   public override string ToString() { return $"Title: {title}, Description: {description}, Service Name: {serviceName}, Labels: {string.Join(", ", labels)}"; }
    }

    public static GitIssue DbIssueToGitIssue(DbIssue dbIssue)
    {
        GitIssue a = new GitIssue();
        a.body = dbIssue.description;
        a.Labels = dbIssue.labels;
        a.Title = dbIssue.title;
        return a;
    }

    public static DbIssue GitIssueToDbIssue(GitIssue gitIssue)
    {
        DbIssue a = new DbIssue();
        a.description = gitIssue.body;
        a.labels = gitIssue.Labels;
        a.title = gitIssue.Title;
        return a;
    }

    public class GitIssue
    {
        [JsonPropertyName("title")] public string Title { get; set; }

        [JsonPropertyName("body")] public string body { get; set; }

        [JsonPropertyName("labels")] public string[] Labels { get; set; }

    }

}
